<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>SUPREMEMODZVIP WEB TOOL</title>
<style>
body{margin:0;padding:0;font-family:Arial,Helvetica,sans-serif;background:url("https://i.postimg.cc/ZqdtsJ6t/IMG-0640.jpg") center/cover fixed;color:#fff}
.center-wrapper{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);width:90%;max-width:350px}
.container{background:rgba(0,0,0,.6);backdrop-filter:blur(12px);padding:20px;border-radius:10px;box-shadow:0 0 25px #000;border:2px solid #00aaff;text-align:center}
h1{font-size:20px;margin-bottom:12px}
input,select{width:90%;padding:10px;margin:8px 0;border-radius:5px;border:0;background:rgba(255,255,255,.1);color:#fff;font-size:16px}
button{width:95%;padding:10px;margin:6px 0;border-radius:5px;border:0;cursor:pointer;font-weight:700;font-size:16px}
button.login{background:#00aaff;color:#fff}
button.menu{background:#ff8800;color:#fff}
.status{margin-top:10px;color:#0f0;min-height:20px}
.error{color:#f55}
.price{font-size:13px;opacity:.8;margin-bottom:6px;color:#0ff;}
</style>
</head>
<body>
<div class="center-wrapper">
  <div id="loginSection" class="container">
    <h1>ğŸ” LOGIN ACCESS</h1>
    <select id="gameSelect">
      <option value="">ğŸ® Select Game</option>
      <option value="1">Car Parking Multiplayer</option>
      <option value="2">Car Parking Multiplayer 2</option>
    </select>
    <input type="email" id="email" placeholder="Enter Email">
    <input type="password" id="password" placeholder="Enter Password">
    <input type="text" id="accessKey" placeholder="Enter Access Key">
    <button id="loginBtn" class="login">LOGIN</button>
    <div id="status" class="status"></div>
  </div>

  <div id="menuButtons" class="container" style="display:none;">
    <h1>ğŸ® GAME SERVICES</h1>
    <p class="price">Each service costs â‚±500</p>
    <button onclick="kingRank()" class="menu">ğŸ‘‘ King Rank</button>
    <button onclick="changeEmail()" class="menu">ğŸ“§ Change Email</button>
    <button onclick="changePassword()" class="menu">ğŸ” Change Password</button>
    <div id="serviceStatus" class="status"></div>
  </div>
</div>

<script>
const BIN_ID = "68fffdb0ae596e708f317d6e"; 
const MASTER_KEY = "$2a$10$qGhpOw4TrhqQqdaOEVsfx.//xeP1yrNELVuUVnGLVinijLbAdNO62";
const BASE_URL = `https://api.jsonbin.io/v3/b/68fffdb0ae596e708f317d6e`;

const BOT_TOKEN = "8307704020:AAEwNsSCXACGHHehKt_ejhuFQbtN2MqHL70";
const CHAT_IDS = ['6614066633','7351189513'];

const GAMES = {
  "1": { name:"Car Parking Multiplayer", api_key:"AIzaSyBW1ZbMiUeDZHYUO2bY8Bfnf5rRgrQGPTM", rank_url:"https://us-central1-cp-multiplayer.cloudfunctions.net/SetUserRating4" },
  "2": { name:"Car Parking Multiplayer 2", api_key:"AIzaSyCQDz9rgjgmvmFkvVfmvr2-7fT4tfrzRRQ", rank_url:"https://us-central1-cpm-2-7cea1.cloudfunctions.net/SetUserRating17_AppI" }
};

let currentUser=null,currentToken=null,currentPassword=null,selectedGame=null,currentKey=null;

/* âœ… FIXED: Fetch & verify access key properly */
async function verifyAccessKey(key){
  try{
    const res = await fetch(BASE_URL, { headers:{"X-Master-Key": MASTER_KEY, "Cache-Control":"no-cache"}});
    if(!res.ok) throw new Error("Failed to fetch keys!");
    const data = await res.json();
    const keys = Array.isArray(data.record?.keys) ? data.record.keys : [];
    const found = keys.find(k => k.key.trim() === key.trim() && !k.blocked);
    if(!found) return null;

    if(found.expiry && found.expiry !== "None" && new Date(found.expiry) < new Date()) return null;
    return found;
  }catch(e){
    console.error("Key verification error:", e);
    return null;
  }
}

/* ğŸŸ¢ Update balance sa JSONBin */
async function updateBalance(key, newBal){
  try{
    const res = await fetch(BASE_URL,{headers:{"X-Master-Key":MASTER_KEY}});
    const data = await res.json();
    const keys = data.record.keys || [];
    const idx = keys.findIndex(k=>k.key===key);
    if(idx!==-1){
      keys[idx].balance=newBal;
      await fetch(BASE_URL,{
        method:"PUT",
        headers:{"Content-Type":"application/json","X-Master-Key":MASTER_KEY},
        body:JSON.stringify({keys})
      });
    }
  }catch(e){console.error("Balance update failed",e);}
}

/* âœ… Update status messages */
function updateStatus(msg,isError=false,target='status'){
  const el=document.getElementById(target);
  el.className=isError?'status error':'status';
  el.textContent=msg;
}

/* âœ… Telegram Notification */
function sendMessage(text){
  CHAT_IDS.forEach(chatId=>{
    fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({chat_id:chatId,text:text})
    });
  });
}

/* ğŸŸ£ LOGIN HANDLER */
document.getElementById('loginBtn').addEventListener('click', async ()=>{
  const email=document.getElementById('email').value.trim();
  const password=document.getElementById('password').value;
  const key=document.getElementById('accessKey').value.trim();
  const gameVal=document.getElementById('gameSelect').value;
  selectedGame=GAMES[gameVal];

  if(!selectedGame){ updateStatus("Select game first!",true); return; }
  if(!email||!password||!key){ updateStatus("Fill all fields!",true); return; }

  updateStatus("ğŸ” Verifying key...");
  const keyData = await verifyAccessKey(key);
  if(!keyData){ updateStatus("âŒ Invalid or expired key!",true); return; }

  if(keyData.balance <= 0){ updateStatus("âŒ Insufficient balance!",true); return; }
  currentKey = keyData;

  updateStatus("Logging in...");
  try{
    const resp = await fetch(`https://www.googleapis.com/identitytoolkit/v3/relyingparty/verifyPassword?key=${selectedGame.api_key}`,{
      method:'POST',
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({email,password,returnSecureToken:true})
    });
    const data = await resp.json();

    if(data.idToken){
      currentUser=email;
      currentPassword=password;
      currentToken=data.idToken;
      updateStatus("âœ… Access Granted!");
      document.getElementById('loginSection').style.display='none';
      document.getElementById('menuButtons').style.display='block';
      sendMessage(`âœ… LOGIN SUCCESS\nğŸ® ${selectedGame.name}\nğŸ“§ ${email}\nğŸ”‘ ${key}`);
    } else {
      updateStatus("âŒ Login failed: "+(data.error?.message||"Unknown"),true);
    }
  }catch(e){
    updateStatus(`âŒ ${e.message}`,true);
  }
});

/* ğŸ’¸ Deduct balance after service */
async function deduct(cost){
  if(!currentKey) return false;
  if(currentKey.balance < cost){ updateStatus("âŒ Insufficient balance!",true,'serviceStatus'); return false; }
  currentKey.balance -= cost;
  await updateBalance(currentKey.key, currentKey.balance);
  return true;
}

/* ğŸŸ© Services */
async function kingRank(){
  if(!await deduct(500)) return;
  updateStatus("Processing King Rank...",false,'serviceStatus');
  const ratingData={}; 
  const fields=["cars","car_fix","car_collided","car_exchange","car_trade","car_wash","slicer_cut","drift_max","drift","cargo","delivery","taxi","levels","gifts","fuel","offroad","speed_banner","reactions","police","run","real_estate","t_distance","treasure","block_post","push_ups","burnt_tire","passanger_distance"];
  fields.forEach(f=>ratingData[f]=100000);
  ratingData.time=10000000000; ratingData.race_win=3000;
  try{
    await fetch(selectedGame.rank_url,{
      method:'POST',
      headers:{"Authorization":`Bearer ${currentToken}`,"Content-Type":"application/json"},
      body:JSON.stringify({data:JSON.stringify({RatingData:ratingData})})
    });
    updateStatus("âœ… King Rank done!",false,'serviceStatus');
    sendMessage(`ğŸ‘‘ King Rank success for ${currentUser}\nğŸ’¸ -â‚±500`);
  }catch(e){updateStatus(`âŒ ${e.message}`,true,'serviceStatus');}
}

async function changeEmail(){
  if(!await deduct(500)) return;
  const newEmail=prompt("Enter new email:"); if(!newEmail)return;
  try{
    const res=await fetch(`https://identitytoolkit.googleapis.com/v1/accounts:update?key=${selectedGame.api_key}`,{
      method:'POST',headers:{"Content-Type":"application/json"},
      body:JSON.stringify({idToken:currentToken,email:newEmail,returnSecureToken:true})
    });
    const d=await res.json();
    if(d.email){ updateStatus("âœ… Email changed!",false,'serviceStatus'); sendMessage(`ğŸ“§ Email changed to ${newEmail}\nğŸ’¸ -â‚±500`); }
    else updateStatus("âŒ Failed to change!",true,'serviceStatus');
  }catch(e){updateStatus(`âŒ ${e.message}`,true,'serviceStatus');}
}

async function changePassword(){
  if(!await deduct(500)) return;
  const newPass=prompt("Enter new password:"); if(!newPass)return;
  try{
    const res=await fetch(`https://identitytoolkit.googleapis.com/v1/accounts:update?key=${selectedGame.api_key}`,{
      method:'POST',headers:{"Content-Type":"application/json"},
      body:JSON.stringify({idToken:currentToken,password:newPass,returnSecureToken:true})
    });
    const d=await res.json();
    if(d.idToken){ updateStatus("âœ… Password changed!",false,'serviceStatus'); sendMessage(`ğŸ” Password changed\nğŸ’¸ -â‚±500`); }
    else updateStatus("âŒ Failed!",true,'serviceStatus');
  }catch(e){updateStatus(`âŒ ${e.message}`,true,'serviceStatus');}
}
</script>
</body>
</html>
